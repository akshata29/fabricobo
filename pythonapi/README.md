# FabricObo Python API

Python implementation of the FabricObo API using FastAPI, MSAL Python, and httpx.  
Functionally equivalent to the .NET API in `../dotnetapi/`.

## Prerequisites

- Python 3.11+
- pip

## Quick Start

```bash
# 1. Create virtual environment
python -m venv .venv
.venv\Scripts\activate        # Windows
# source .venv/bin/activate   # macOS/Linux

# 2. Install dependencies
pip install -r requirements.txt

# 3. Configure — copy .env.example to .env and fill in your values
cp .env.example .env

# 4. Run the API
python main.py
# Or: uvicorn main:app --host 0.0.0.0 --port 5180 --reload
```

The API runs on `http://localhost:5180` — same port as the .NET API.
Only run one at a time (they share the same port).

## Endpoints

| Method | Path             | Auth Required | Description                                    |
|--------|------------------|---------------|------------------------------------------------|
| POST   | `/api/agent`     | Yes (JWT)     | Main agent endpoint — OBO → Foundry            |
| GET    | `/api/config`    | No            | SPA authentication config (public values)      |
| POST   | `/api/messages`  | No*           | Bot Framework endpoint (Teams/Copilot Studio)  |
| GET    | `/health`        | No            | Health check                                   |
| GET    | `/docs`          | No            | Swagger UI (auto-generated by FastAPI)          |

\* Bot Framework authentication is handled by the Bot Framework protocol, not JWT.

## Architecture

```
pythonapi/
├── main.py                    # FastAPI app + routes (≈ Program.cs + Controllers)
├── config.py                  # Settings / configuration (≈ appsettings.json binding)
├── models.py                  # Request/Response DTOs (≈ Models/)
├── auth.py                    # JWT validation + OBO exchange (≈ Microsoft.Identity.Web)
├── foundry_agent_service.py   # Foundry Responses API client (≈ Services/FoundryAgentService.cs)
├── entitlement_service.py     # Stub entitlement lookup (≈ Services/StubEntitlementService.cs)
├── bot_handler.py             # Bot Framework handler (≈ Bot/FabricOboBot.cs)
├── requirements.txt           # Python dependencies (≈ FabricObo.csproj PackageReferences)
├── .env.example               # Environment variable template (≈ appsettings.example.json)
└── README.md                  # This file
```

## .NET ↔ Python Mapping

| .NET Component                         | Python Equivalent                    |
|----------------------------------------|--------------------------------------|
| `Program.cs`                           | `main.py`                            |
| `Microsoft.Identity.Web`               | `msal` + `python-jose`              |
| `ITokenAcquisition` (OBO)             | `OboTokenService` in `auth.py`      |
| `IHttpClientFactory`                   | `httpx.AsyncClient`                 |
| `Controllers/AgentController.cs`       | `post_agent()` in `main.py`         |
| `Controllers/ConfigController.cs`      | `get_config()` in `main.py`         |
| `Services/FoundryAgentService.cs`      | `foundry_agent_service.py`          |
| `Services/StubEntitlementService.cs`   | `entitlement_service.py`            |
| `Bot/FabricOboBot.cs`                  | `bot_handler.py`                    |
| `appsettings.json`                     | `.env`                               |

## Configuration

Copy `.env.example` to `.env` and fill in your values. Each env var maps
to a setting in the .NET `appsettings.json`:

| .env Variable                  | appsettings.json Equivalent             |
|--------------------------------|-----------------------------------------|
| `AZUREAD_TENANT_ID`            | `AzureAd:TenantId`                     |
| `AZUREAD_CLIENT_ID`            | `AzureAd:ClientId`                     |
| `AZUREAD_CLIENT_SECRET`        | `AzureAd:ClientSecret`                 |
| `AZUREAD_AUDIENCE`             | `AzureAd:Audience`                     |
| `FOUNDRY_PROJECT_ENDPOINT`     | `Foundry:ProjectEndpoint`              |
| `FOUNDRY_AGENT_NAME`           | `Foundry:AgentName`                    |
| `FOUNDRY_FABRIC_CONNECTION_ID` | `Foundry:FabricConnectionId`           |
| `SPA_TENANT_ID`                | `SpaAuth:TenantId`                     |
| `SPA_SPA_CLIENT_ID`            | `SpaAuth:SpaClientId`                  |
| `SPA_API_CLIENT_ID`            | `SpaAuth:ApiClientId`                  |
| `SPA_TEST_USERS_JSON`          | `SpaAuth:TestUsers` (as JSON array)    |
| `ENTITLEMENT_USERS_JSON`       | `Entitlements:Users` (as JSON array)   |
| `CORS_ALLOWED_ORIGINS`         | `Cors:AllowedOrigins` (comma-separated)|

## Bot Support

The Python API includes a basic Bot Framework message handler (`bot_handler.py`).
For full Teams bot functionality with SSO, sign-in cards, and multi-turn
conversation state, use the .NET API (`../dotnetapi/`).
